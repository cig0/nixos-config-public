= My NixOS flake
:author: Martín Cigorraga
:email:  cig0.github@tutanota.com
:doctype: article

This is the result of my elbow grease after six weeks of having migrated to NixOS and working on the flake. I hope you find it useful in the same way I found many similar resources that helped me quickly start building my system configuration 🤓

++++
<div></p></div>
++++

image::.assets/frostedflakes.jpg[alt="Frosted Flakes", align="center"]

++++
<div style="text-align: center;">
<i>Picture credits: Robin Jakobsson - <a href="https://www.flickr.com/photos/robinjakobsson/8491521693">Flickr</a></i>
</p>
</div>
++++

toc::[]

== Flake structure

[,bash]
----
nixos-config-public on  main took 3s λ tree --dirsfirst -av --matchdirs -I '.git|.vscode'
.
├── .assets
│   ├── frostedflakes.jpg
│   └── wip.webp
├── .etc
│   └── nixos
│       └── confusedungabunga.gif
├── home-manager
│   └── modules
│       └── .gitkeep
├── nixos
│   ├── helpers
│   │   └── hostnames.nix
│   ├── hosts
│   │   ├── perrrkele
│   │   │   ├── configuration.nix
│   │   │   └── hardware-configuration.nix
│   │   ├── satama
│   │   └── vittusaatana
│   ├── modules
│   │   ├── applications
│   │   │   ├── applications.nix
│   │   │   ├── current-system-packages.nix
│   │   │   ├── nix-flatpak.nix
│   │   │   ├── nixvim.nix
│   │   │   ├── ollama.nix
│   │   │   └── syncthing.nix
│   │   ├── desktop-environments
│   │   │   ├── cosmic.nix
│   │   │   ├── kdeconnect.nix
│   │   │   ├── sddm.nix
│   │   │   └── xdg-desktop-portal.nix
│   │   ├── networking
│   │   │   ├── dns.nix
│   │   │   ├── stevenblack-unblacklist.nix
│   │   │   ├── stevenblack.nix
│   │   │   └── tailscale.nix
│   │   ├── observability
│   │   │   ├── netdata.nix
│   │   │   └── observability.nix
│   │   ├── power-management
│   │   │   ├── auto-cpufreq.nix
│   │   │   └── power-management.nix
│   │   ├── security
│   │   │   ├── secrets
│   │   │   │   └── secrets.yaml
│   │   │   ├── firewall.nix
│   │   │   ├── lanzaboote.nix
│   │   │   ├── openssh.nix
│   │   │   ├── sops.nix
│   │   │   └── sshguard.nix
│   │   ├── shell
│   │   │   ├── starship.nix
│   │   │   └── zsh.nix
│   │   ├── system
│   │   │   ├── cups.nix
│   │   │   ├── fonts.nix
│   │   │   ├── fwupd.nix
│   │   │   ├── gnupg.nix
│   │   │   ├── hwaccel.nix
│   │   │   ├── kernel.nix
│   │   │   ├── keyd.nix
│   │   │   ├── maintenance.nix
│   │   │   ├── pcscd.nix
│   │   │   ├── plymouth.nix
│   │   │   ├── ucode.nix
│   │   │   ├── users.nix
│   │   │   └── zram.nix
│   │   ├── time-and-date
│   │   │   ├── ntp.nix
│   │   │   └── timezone.nix
│   │   ├── virtualisation
│   │   │   ├── containerization.nix
│   │   │   ├── incus.nix
│   │   │   └── libvirt.nix
│   │   └── home-manager.nix
│   └── overlays
│       ├── nixos-option.nix
│       └── overlays.nix
├── .sops.yaml
├── README.adoc
├── flake.lock
└── flake.nix

25 directories, 58 files
----

link:.etc/nixos/confusedungabunga.gif[.etc/nixos/confusedungabunga.gif]:: Your friends' face when you show them your `/etc/nixos` directory.
link:home-manager[home-manager/]:: Placeholder for *Home Manager* configuration.
link:nixos[nixos/]:: The operating system configuration files.
link:nixos/helpers[helpers/]::: Reusable routines for configuring NixOS.
link:nixos/helpers/hostnames.nix[hostnames.nix]:::: A list of the hosts and groups of hosts you manage. With this bit of code you can easily reference them when deciding what actions to take on each one, allowing for better flexibility an reusability when creating your code.
link:nixos/hosts[hosts/]::: The hosts you manage. Each host directory should contain only the two default files `configuration.nix` and `hardware-configuration.nix`.
link:nixos/hosts/perrrkele/configuration.nix[perrrkele/configuration.nix]:::: This file should define _the specifics_ to the host; anything else should be managed as a host-agnostic module.
link:nixos/hosts/perrrkele/hardware-configuration.nix[perrrkele/hardware-configuration.nix]:::: Placeholder; this file is specific to each host.
link:nixos/modules[modules/]::: The modules for managing NixOS.
link:nixos/modules/applications/applications.nix[applications/applications.nix]:::: Tools and applications.
link:nixos/modules/applications/current-system-packages.nix[applications/current-system-packages.nix]:::: List of installed packages.
link:nixos/modules/applications/nix-flatpak.nix[applications/nix-flatpak.nix]:::: Flatpak applications automagic management.
link:nixos/modules/applications/nixvim.nix[applications/nixvim.nix]:::: Neovim configuration.
link:nixos/modules/applications/ollama.nix[applications/ollama.nix]:::: Ollama configuration.
link:nixos/modules/applications/syncthing.nix[applications/syncthing.nix]:::: Syncthing example configuration.
link:nixos/modules/desktop-environments/cosmic.nix[desktop-environments/cosmic.nix]:::: COSMIC Desktop Environment configuration.
link:nixos/modules/desktop-environments/kdeconnect.nix[desktop-environments/kdeconnect.nix]:::: KDE Connect service configuration.
link:nixos/modules/desktop-environments/sddm.nix[desktop-environments/sddm.nix]:::: Login manager.
link:nixos/modules/desktop-environments/xdg-desktop-portal.nix[desktop-environments/xdg-desktop-portal.nix]:::: XDG Desktop portal integration for KDE.
link:nixos/modules/networking/dns.nix[networking/dns.nix]:::: Host and Tailscale DNS configuration.
link:nixos/modules/networking/stevenblack-unblacklist.nix[networking/stevenblack-unblacklist]:::: Remove hosts from the hosts blocking list.
link:nixos/modules/networking/stevenblack.nix[networking/stevenblack.nix]:::: Enable the selected block lists.
link:nixos/modules/networking/tailscale.nix[networking/tailscale.nix]:::: Tailscale configuration.
link:nixos/modules/observability/netdata.nix[observability/netdata.nix]:::: NetData configuration.
link:nixos/modules/observability/observability.nix[observability/observability.nix]:::: Enable selected observability modules.
link:nixos/modules/power-management/auto-cpufreq.nix[power-management/auto-cpufreq.nix]:::: Energy efficiency module.
link:nixos/modules/power-management/power-management.nix[power-management/power-management.nix]:::: Power management module.
link:nixos/modules/security/secrets[security/secrets/]:::: SOPS secrets fiales.
link:nixos/modules/security/firewall.nix[security/firewall.nix]:::: Firewall management.
link:nixos/modules/security/lanzaboote.nix[security/lanzaboote.nix]:::: Secure boot enablement.
link:nixos/modules/security/openssh.nix[security/openssh.nix]:::: OpenSSH server.
link:nixos/modules/security/sops.nix[security/sops.nix]:::: Mozilla's SOPS configuration.
link:nixos/modules/security/sshguard.nix[security/sshguard.nix]:::: Services protection.
link:nixos/modules/shell/starship.nix[shell/starship.nix]:::: Starship prompt enhancer configuration.
link:nixos/modules/shell/zsh.nix[shell/zsh.nix]:::: Zsh configuration.
link:nixos/modules/system/cups.nix[system/cups.nix]:::: Print server.
link:nixos/modules/system/fonts.nix[system/fonts.nix]:::: Fonts management and configuration.
link:nixos/modules/system/fwupd.nix[system/fwupd.nix]:::: Upgrade your decices' firmware.
link:nixos/modules/system/gnupg.nix[system/gnupg.nix]:::: Enable the GNU GPG agent (keyring).
link:nixos/modules/system/hwaccel.nix[system/hwaccel.nix]:::: Hardware acceleration configuration.
link:nixos/modules/system/kernel.nix[system/kernel.nix]:::: Kernel configuration.
link:nixos/modules/system/keyd.nix[system/keyd.nix]:::: Keyboard mapping. Both my laptop's and external keyboard lack the Ins key, so I'm mapping its functionality to another key-combination.
link:nixos/modules/system/maintenance.nix[system/maintenance.nix]:::: System auto-upgrade and store auto-cleanup configuration.
link:nixos/modules/system/pcscd.nix[system/pcscd.nix]:::: Smart cards service configuration.
link:nixos/modules/system/plymouth.nix[system/plymouth.nix]:::: Graphical boot configuration.
link:nixos/modules/system/ucode.nix[system/ucode.nix]:::: Intel and AMD CPU microcode update.
link:nixos/modules/system/users.nix[system/users.nix]:::: Users management.
link:nixos/modules/system/zram.nix[system/zram.nix]:::: Zram service configuration.
link:nixos/modules/time-and-date/ntp.nix[time-and-date/ntp.nix]:::: NTP servers configuration.
link:nixos/modules/time-and-date/timezone.nix[time-and-date/timezone.nix]:::: Timezone configuration.
link:nixos/modules/virtualisation/containerization.nix[virtualisation/containerization.nix]:::: Enable and configure containerization utilities, i.e. Podman.
link:nixos/modules/virtualisation/incus.nix[virtualisation/incus.nix]:::: Configure Linux Containers (LXD) successor, Incus.
link:nixos/modules/virtualisation/libvirt.nix[virtualisation/libvirt.nix]:::: Configure libvirt/virtio virtualisation.
link:nixos/modules/home-manager.nix[home-manager.nix]:::: Home Manager global configuration.
link:nixos/overlays/nixos-options.nix[overlays/nixos-options.nix]::: `nixos-options` fix for flake-enabled systems.
link:nixos/overlays/overlays.nix[overlays/overlays.nix]::: Overlays enablement.

== 💡 Quick reference

=== Creating a generation:

- With NixOS built-in tooling: `nixos-rebuild test --use-remote-sudo --update-input nixpkgs --update-input nixpkgs-unstable --flake ~/.nixos-config`
- With link:https://github.com/viperML/nh[nh]: `nh os test --update ~/.nixos-config`

---

image::.assets/wip.webp[alt="Frosted Flakes", align="center"]

== ✔️ TO DO

_In no particular order_

- [ ] Add links to the unofficial Discord server, link:https://mynixos.com[MyNixOS], and similar resources.
- [x] Finish adding modules descriptions.
- [ ] Add Table of Contents.
- [ ] Add walkthrough of `flake.nix`.
- [ ] Add missing logic for the rest of the hosts, i.e. to `kernel.nix`.
- [ ] Keep populating the quick reference section.
- [ ] Incorporate many of the Justfile awesome custom commands from the link:https://universal-blue.org[Universal Blue] team.
