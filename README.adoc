= My NixOS flake
:author: MartÃ­n Cigorraga
:email:  cig0.github@tutanota.com
:doctype: article

This is the result of my elbow grease after six weeks of having migrated to NixOS and working on the flake. I hope you find it useful in the same way I found many similar resources that helped me quickly start building my system configuration ğŸ¤“

++++
<div></p></div>
++++

image::.assets/frostedflakes.jpg[alt="Frosted Flakes", align="center"]

++++
<div style="text-align: center;">
<i>Picture credits: Robin Jakobsson - <a href="https://www.flickr.com/photos/robinjakobsson/8491521693">Flickr</a></i>
</p>
</div>
++++

toc::[]

== Flake structure

[,bash]
----
.
â”œâ”€â”€ .etc
â”‚Â Â  â””â”€â”€ nixos
â”‚Â Â      â””â”€â”€ confusedungabunga.gif
â”œâ”€â”€ home-manager
â”‚Â Â  â””â”€â”€ modules
â”‚Â Â      â””â”€â”€ .gitkeep
â”œâ”€â”€ nixos
â”‚Â Â  â”œâ”€â”€ helpers
â”‚Â Â  â”‚Â Â  â””â”€â”€ hostnames.nix
â”‚Â Â  â”œâ”€â”€ hosts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ perrrkele
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ configuration.nix
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ hardware-configuration.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ satama
â”‚Â Â  â”‚Â Â  â””â”€â”€ vittusaatana
â”‚Â Â  â”œâ”€â”€ modules
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ auto-cpufreq.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cosmic.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cups.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ current-system-packages.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dns.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ emacs.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ firefox.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ firewall.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ fonts.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ fwupd.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ gnupg.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ homemanager.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ hwaccel.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kdeconnect.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kernel.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ keyd.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ monitoring.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mtr.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ nix-flatpak.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ nixvim.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ntp.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ollama.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ openssh.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ pcscd.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ plymouth.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ powermanagement.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ sddm.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ sops.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ sshguard.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ starship.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ stevenblack-unblacklist.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ stevenblack.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ syncthing.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ systemmaintenance.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ systempackages.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ tailscale.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ timezone.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ucode.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ungoogled-chromium.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ users.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ virtualization.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ xdg-desktop-portal.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ zram.nix
â”‚Â Â  â”‚Â Â  â””â”€â”€ zsh.nix
â”‚Â Â  â””â”€â”€ overlays
â”‚Â Â      â”œâ”€â”€ nixos-option.nix  # Fixes nixos-option when using flakes
â”‚Â Â      â””â”€â”€ overlays.nix  # Selectively load overlays
â”œâ”€â”€ secrets
â”‚Â Â  â””â”€â”€ secrets.yaml
â”œâ”€â”€ .sops.yaml
â”œâ”€â”€ README.adoc
â”œâ”€â”€ flake.lock
â””â”€â”€ flake.nix

16 directories, 57 files
----

link:.etc/nixos/confusedungabunga.gif[.etc/nixos/confusedungabunga.gif]:: Your friends' face when you show them your `/etc/nixos` directory.
link:home-manager[home-manager/]:: Placeholder for *Home Manager* configuration.
link:nixos[nixos/]:: The operating system configuration files.
link:nixos/helpers[helpers/]::: Reusable routines for configuring NixOS.
link:nixos/helpers/hostnames.nix[hostnames.nix]:::: A list of the hosts and groups of hosts you manage. With this bit of code you can easily reference them when deciding what actions to take on each one, allowing for better flexibility an reusability when creating your code.
link:nixos/hosts[hosts/]::: The hosts you manage. Each host directory should contain only the two default files `configuration.nix` and `hardware-configuration.nix`.
link:nixos/hosts/perrrkele/configuration.nix[perrrkele/configuration.nix]:::: This file should define _the specifics_ to the host; anything else should be managed as a host-agnostic module.
link:nixos/hosts/perrrkele/hardware-configuration.nix[perrrkele/hardware-configuration.nix]:::: Placeholder; this file is specific to each host.
link:nixos/modules[modules/]::: The modules for managing NixOS.
link:nixos/modules/apps.nix[apps.nix]:::: Tools and applications.
link:nixos/modules/auto-cpufreq.nix[auto-cpufreq.nix]:::: Energy efficiency.
link:nixos/modules/cosmic.nix[cosmic.nix]:::: COSMIC Desktop Environment configuration.
link:nixos/modules/cups.nix[cups.nix]:::: CUPS server.
link:nixos/modules/current-system-packages.nix[current-system-packages.nix]:::: Creates the file `/etc/current-system-packages.nix` with the content of all the packages installed in your system =)
link:nixos/modules/dns.nix[dns.nix]:::: Host DNS configuration.
link:nixos/modules/firewall.nix[firewall.nix]:::: Configure your firewall and track applications ports settings.
link:nixos/modules/fonts.nix[fonts.nix]:::: Fonts management and configuration.
link:nixos/modules/fwupd.nix[fwupd.nix]:::: Upgrade your decices' firmware.
link:nixos/modules/gnupg.nix[gnupg.nix]:::: Enable the GNU GPG agent (keyring).
link:nixos/modules/homemanager.nix[homemanager.nix]:::: Home Manager global configuration.
link:nixos/modules/hwaccel.nix[hwaccel.nix]:::: Hardware acceleration configuration.
link:nixos/modules/kdeconnect.nix[kdeconnect.nix]:::: KDE Connect service configuration.
link:nixos/modules/kernel.nix[kernel.nix]:::: Kernel configuration.
link:nixos/modules/keyd.nix[keyd.nix]:::: Keyboard mapping. Both my laptop's and external keyboard lack the Ins key, so I'm mapping its functionality to another key-combination.
link:nixos/modules/nix-flatpak.nix[nix-flatpak.nix]::::
link:nixos/modules/nixvim.nix[nixvim.nix]::::
link:nixos/modules/ntp.nix[ntp.nix]::::
link:nixos/modules/observability.nix[observability.nix]::::
link:nixos/modules/ollama.nix[ollama.nix]::::
link:nixos/modules/openssh.nix[openssh.nix]::::
link:nixos/modules/pcsdc.nix[pcsdc.nix]::::
link:nixos/modules/plymouth.nix[plymouth.nix]::::
link:nixos/modules/powermanagement.nix[powermanagement.nix]::::
link:nixos/modules/sddm.nix[sddm.nix]::::
link:nixos/modules/sops.nix[sops.nix]::::
link:nixos/modules/sshguard.nix[sshguard.nix]::::
link:nixos/modules/starship.nix[starship.nix]::::
link:nixos/modules/stevenblack-unblacklist.nix[stevenblack-unblacklist]::::
link:nixos/modules/stevenblack.nix[stevenblack]::::
link:nixos/modules/syncthing.nix[syncthing.nix]::::
link:nixos/modules/systemmaintenance.nix[systemmaintenance.nix]::::
link:nixos/modules/tailscale.nix[tailscale.nix]::::
link:nixos/modules/timezone.nix[timezone.nix]::::
link:nixos/modules/ucode.nix[ucode.nix]::::
link:nixos/modules/users.nix[users.nix]::::
link:nixos/modules/virtualization.nix[virtualization.nix]::::
link:nixos/modules/xdg-desktop-portal.nix[xdg-desktop-portal.nix]::::
link:nixos/modules/zram.nix[zram.nix]::::
link:nixos/modules/zsh.nix[zsh.nix]::::
link:nixos/overlays/nixos-option.nix[nixos-option.nix]::::
link:nixos/overlays/overlays.nix[overlays.nix]::::

== ğŸ’¡ Quick reference

=== Creating a generation:

- With NixOS built-in tooling: `nixos-rebuild test --use-remote-sudo --update-input nixpkgs --update-input nixpkgs-unstable --flake ~/.nixos-config`
- With link:https://github.com/viperML/nh[nh]: `nh os test --update ~/.nixos-config`

---

image::.assets/wip.webp[alt="Frosted Flakes", align="center"]

== âœ”ï¸ TO DO

_In no particular order_

- [ ] Add links to the unofficial Discord server, link:https://mynixos.com[MyNixOS], and similar resources.
- [ ] Finish adding modules descriptions.
- [ ] Add Table of Contents.
- [ ] Add walkthrough of `flake.nix`.
- [ ] Add missing logic for the rest of the hosts, i.e. to `kernel.nix`.
- [ ] Keep populating the quick reference section.
- [ ] Incorporate many of the Justfile awesome custom commands from the link:https://universal-blue.org[Universal Blue] team.